/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
var BlobService = /** @class */ (function () {
    function BlobService(http) {
        this.http = http;
    }
    /**
     * @param {?} params
     * @param {?} filename
     * @param {?=} useAzureStorageEmulator
     * @param {?=} azureStorageEmulatorBaseUrl
     * @return {?}
     */
    BlobService.prototype.generateBlobUrl = /**
     * @param {?} params
     * @param {?} filename
     * @param {?=} useAzureStorageEmulator
     * @param {?=} azureStorageEmulatorBaseUrl
     * @return {?}
     */
    function (params, filename, useAzureStorageEmulator, azureStorageEmulatorBaseUrl) {
        if (useAzureStorageEmulator === void 0) { useAzureStorageEmulator = false; }
        if (azureStorageEmulatorBaseUrl === void 0) { azureStorageEmulatorBaseUrl = ''; }
        /** @type {?} */
        var url = useAzureStorageEmulator ? azureStorageEmulatorBaseUrl : "https://" + params.storageAccount + ".blob.core.windows.net";
        return url + "/" + params.containerName + "/" + filename;
    };
    /**
     * @param {?} reader
     * @param {?} state
     * @return {?}
     */
    BlobService.prototype.uploadFileInBlocks = /**
     * @param {?} reader
     * @param {?} state
     * @return {?}
     */
    function (reader, state) {
        if (!state.cancelled) {
            if (state.totalBytesRemaining > 0) {
                /** @type {?} */
                var fileContent = state.file.slice(state.currentFilePointer, state.currentFilePointer + state.maxBlockSize);
                /** @type {?} */
                var blockId = state.blockIdPrefix + this.prependZeros(state.blockIds.length, 6);
                state.blockIds.push(btoa(blockId));
                reader.readAsArrayBuffer(fileContent);
                state.currentFilePointer += state.maxBlockSize;
                state.totalBytesRemaining -= state.maxBlockSize;
                if (state.totalBytesRemaining < state.maxBlockSize) {
                    state.maxBlockSize = state.totalBytesRemaining;
                }
            }
            else {
                this.commitBlockList(state);
            }
        }
    };
    /**
     * @param {?} state
     * @return {?}
     */
    BlobService.prototype.commitBlockList = /**
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var uri = state.fileUrl + '&comp=blocklist';
        /** @type {?} */
        var headers = new HttpHeaders({ 'x-ms-blob-content-type': state.file.type });
        /** @type {?} */
        var requestBody = '<?xml version=\'1.0\' encoding=\'utf-8\'?><BlockList>';
        for (var i = 0; i < state.blockIds.length; i++) {
            requestBody += '<Latest>' + state.blockIds[i] + '</Latest>';
        }
        requestBody += '</BlockList>';
        this.http.put(uri, requestBody, { headers: headers, responseType: 'text' })
            .subscribe(function (_elem) {
            if (state.complete) {
                state.complete();
            }
        }, function (err) {
            console.log({ error: err });
            if (state.error) {
                state.error(err);
            }
        });
    };
    /**
     * @param {?} config
     * @return {?}
     */
    BlobService.prototype.initializeState = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        /** @type {?} */
        var blockSize = BlobService.DefaultBlockSize;
        if (config.blockSize) {
            blockSize = config.blockSize;
        }
        /** @type {?} */
        var maxBlockSize = blockSize;
        /** @type {?} */
        var numberOfBlocks = 1;
        /** @type {?} */
        var file = config.file;
        /** @type {?} */
        var fileSize = file.size;
        if (fileSize < blockSize) {
            maxBlockSize = fileSize;
        }
        if (fileSize % maxBlockSize === 0) {
            numberOfBlocks = fileSize / maxBlockSize;
        }
        else {
            numberOfBlocks = fileSize / maxBlockSize + 1;
        }
        return {
            maxBlockSize: maxBlockSize,
            // Each file will be split in 256 KB.
            numberOfBlocks: numberOfBlocks,
            totalBytesRemaining: fileSize,
            currentFilePointer: 0,
            blockIds: new Array(),
            blockIdPrefix: 'block-',
            bytesUploaded: 0,
            submitUri: null,
            file: file,
            baseUrl: config.baseUrl,
            sasToken: config.sasToken,
            fileUrl: config.baseUrl + config.sasToken,
            progress: config.progress,
            complete: config.complete,
            error: config.error,
            cancelled: false
        };
    };
    /**
     * @param {?} config
     * @return {?}
     */
    BlobService.prototype.upload = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        var _this = this;
        /** @type {?} */
        var state = this.initializeState(config);
        /** @type {?} */
        var reader = new FileReader();
        reader.onloadend = function (evt) {
            if (evt.target.readyState === 2 && !state.cancelled) {
                /** @type {?} */
                var uri = state.fileUrl + '&comp=block&blockid=' + state.blockIds[state.blockIds.length - 1];
                /** @type {?} */
                var requestData = evt.target.result;
                /** @type {?} */
                var requestData2_1 = new Uint8Array(evt.target.result);
                /** @type {?} */
                var headers = new HttpHeaders({ 'x-ms-blob-type': 'BlockBlob', 'Content-Type': 'application/octet-stream' });
                _this.http.put(uri, requestData, { headers: headers, responseType: 'text' })
                    .subscribe(function (_elem) {
                    state.bytesUploaded += requestData2_1.length;
                    /** @type {?} */
                    var percentComplete = Math.round((state.bytesUploaded / state.file.size) * 1000) / 10;
                    if (state.progress) {
                        state.progress(percentComplete);
                    }
                    _this.uploadFileInBlocks(reader, state);
                }, function (err) {
                    console.log({ error: err });
                    if (state.error) {
                        state.error(err);
                    }
                });
            }
        };
        this.uploadFileInBlocks(reader, state);
        return {
            cancel: function () {
                state.cancelled = true;
            }
        };
    };
    /**
     * @param {?} number
     * @param {?} length
     * @return {?}
     */
    BlobService.prototype.prependZeros = /**
     * @param {?} number
     * @param {?} length
     * @return {?}
     */
    function (number, length) {
        /** @type {?} */
        var str = '' + number;
        while (str.length < length) {
            str = '0' + str;
        }
        return str;
    };
    BlobService.DefaultBlockSize = 1024 * 32;
    BlobService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BlobService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    return BlobService;
}());
export { BlobService };
if (false) {
    /** @type {?} */
    BlobService.DefaultBlockSize;
    /** @type {?} */
    BlobService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvYi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1henVyZS1ibG9iLXNlcnZpY2UvIiwic291cmNlcyI6WyJzcmMvYXBwL21vZHVsZXMvYmxvYi9ibG9iLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDMUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTs7SUFLNUQscUJBQXFCLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7S0FBSzs7Ozs7Ozs7SUFDMUMscUNBQWU7Ozs7Ozs7SUFBZixVQUNFLE1BQW9CLEVBQ3BCLFFBQWdCLEVBQ2hCLHVCQUErQixFQUMvQiwyQkFBZ0M7UUFEaEMsd0NBQUEsRUFBQSwrQkFBK0I7UUFDL0IsNENBQUEsRUFBQSxnQ0FBZ0M7O1FBQ2hDLElBQU0sR0FBRyxHQUFHLHVCQUF1QixDQUFDLENBQUMsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLENBQUMsYUFBVyxNQUFNLENBQUMsY0FBYywyQkFBd0IsQ0FBQTtRQUM1SCxPQUFVLEdBQUcsU0FBSSxNQUFNLENBQUMsYUFBYSxTQUFJLFFBQVUsQ0FBQTtLQUNwRDs7Ozs7O0lBQ08sd0NBQWtCOzs7OztjQUFFLE1BQU0sRUFBRSxLQUFLO1FBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksS0FBSyxDQUFDLG1CQUFtQixHQUFHLENBQUMsRUFBRTs7Z0JBQy9CLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFBOztnQkFDN0csSUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUss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Q3JCLE9BQU8sR0FBRyxDQUFDLE1BQU0sR0FBRyxNQUFNLEVBQUU7WUFDMUIsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUE7U0FDaEI7UUFDRCxPQUFPLEdBQUcsQ0FBQTs7bUNBN0hjLElBQUksR0FBRyxFQUFFOztnQkFGcEMsVUFBVTs7OztnQkFGRixVQUFVOztzQkFEbkI7O1NBSWEsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJ1xyXG5pbXBvcnQgeyBVcGxvYWRQYXJhbXMsIFVwbG9hZENvbmZpZyB9IGZyb20gJy4vZGVmaW5pdGlvbnMnXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJsb2JTZXJ2aWNlIHtcclxuICBzdGF0aWMgRGVmYXVsdEJsb2NrU2l6ZSA9IDEwMjQgKiAzMlxyXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxyXG4gIGdlbmVyYXRlQmxvYlVybCAoXHJcbiAgICBwYXJhbXM6IFVwbG9hZFBhcmFtcyxcclxuICAgIGZpbGVuYW1lOiBzdHJpbmcsXHJcbiAgICB1c2VBenVyZVN0b3JhZ2VFbXVsYXRvciA9IGZhbHNlLFxyXG4gICAgYXp1cmVTdG9yYWdlRW11bGF0b3JCYXNlVXJsID0gJycpIHtcclxuICAgIGNvbnN0IHVybCA9IHVzZUF6dXJlU3RvcmFnZUVtdWxhdG9yID8gYXp1cmVTdG9yYWdlRW11bGF0b3JCYXNlVXJsIDogYGh0dHBzOi8vJHtwYXJhbXMuc3RvcmFnZUFjY291bnR9LmJsb2IuY29yZS53aW5kb3dzLm5ldGBcclxuICAgIHJldHVybiBgJHt1cmx9LyR7cGFyYW1zLmNvbnRhaW5lck5hbWV9LyR7ZmlsZW5hbWV9YFxyXG4gIH1cclxuICBwcml2YXRlIHVwbG9hZEZpbGVJbkJsb2NrcyAocmVhZGVyLCBzdGF0ZSkge1xyXG4gICAgICBpZiAoIXN0YXRlLmNhbmNlbGxlZCkge1xyXG4gICAgICAgICAgaWYgKHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgPiAwKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmlsZUNvbnRlbnQgPSBzdGF0ZS5maWxlLnNsaWNlKHN0YXRlLmN1cnJlbnRGaWxlUG9pbnRlciwgc3RhdGUuY3VycmVudEZpbGVQb2ludGVyICsgc3RhdGUubWF4QmxvY2tTaXplKVxyXG4gICAgICAgICAgICAgIGNvbnN0IGJsb2NrSWQgPSBzdGF0ZS5ibG9ja0lkUHJlZml4ICsgdGhpcy5wcmVwZW5kWmVyb3Moc3RhdGUuYmxvY2tJZHMubGVuZ3RoLCA2KVxyXG4gICAgICAgICAgICAgIHN0YXRlLmJsb2NrSWRzLnB1c2goYnRvYShibG9ja0lkKSlcclxuICAgICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZUNvbnRlbnQpXHJcbiAgICAgICAgICAgICAgc3RhdGUuY3VycmVudEZpbGVQb2ludGVyICs9IHN0YXRlLm1heEJsb2NrU2l6ZVxyXG4gICAgICAgICAgICAgIHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgLT0gc3RhdGUubWF4QmxvY2tTaXplXHJcbiAgICAgICAgICAgICAgaWYgKHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgPCBzdGF0ZS5tYXhCbG9ja1NpemUpIHtcclxuICAgICAgICAgICAgICAgICAgc3RhdGUubWF4QmxvY2tTaXplID0gc3RhdGUudG90YWxCeXRlc1JlbWFpbmluZ1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jb21taXRCbG9ja0xpc3Qoc3RhdGUpXHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBjb21taXRCbG9ja0xpc3QgKHN0YXRlKSB7XHJcbiAgICAgIGNvbnN0IHVyaSA9IHN0YXRlLmZpbGVVcmwgKyAnJmNvbXA9YmxvY2tsaXN0J1xyXG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ3gtbXMtYmxvYi1jb250ZW50LXR5cGUnOiBzdGF0ZS5maWxlLnR5cGUgfSlcclxuICAgICAgbGV0IHJlcXVlc3RCb2R5ID0gJzw/eG1sIHZlcnNpb249XFwnMS4wXFwnIGVuY29kaW5nPVxcJ3V0Zi04XFwnPz48QmxvY2tMaXN0PidcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0ZS5ibG9ja0lkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgcmVxdWVzdEJvZHkgKz0gJzxMYXRlc3Q+JyArIHN0YXRlLmJsb2NrSWRzW2ldICsgJzwvTGF0ZXN0PidcclxuICAgICAgfVxyXG4gICAgICByZXF1ZXN0Qm9keSArPSAnPC9CbG9ja0xpc3Q+J1xyXG5cclxuICAgICAgdGhpcy5odHRwLnB1dCh1cmksIHJlcXVlc3RCb2R5LCB7IGhlYWRlcnM6IGhlYWRlcnMsIHJlc3BvbnNlVHlwZTogJ3RleHQnIH0pXHJcbiAgICAgICAgLnN1YnNjcmliZShfZWxlbSA9PiB7XHJcbiAgICAgICAgICBpZiAoc3RhdGUuY29tcGxldGUpIHtcclxuICAgICAgICAgICAgc3RhdGUuY29tcGxldGUoKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sIGVyciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyh7IGVycm9yOiBlcnIgfSlcclxuICAgICAgICAgIGlmIChzdGF0ZS5lcnJvcikge1xyXG4gICAgICAgICAgICBzdGF0ZS5lcnJvcihlcnIpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICB9XHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplU3RhdGUgKGNvbmZpZzogVXBsb2FkQ29uZmlnKSB7XHJcbiAgICAgIGxldCBibG9ja1NpemUgPSBCbG9iU2VydmljZS5EZWZhdWx0QmxvY2tTaXplXHJcbiAgICAgIGlmIChjb25maWcuYmxvY2tTaXplKSB7XHJcbiAgICAgICAgYmxvY2tTaXplID0gY29uZmlnLmJsb2NrU2l6ZVxyXG4gICAgICB9XHJcbiAgICAgIGxldCBtYXhCbG9ja1NpemUgPSBibG9ja1NpemVcclxuICAgICAgbGV0IG51bWJlck9mQmxvY2tzID0gMVxyXG4gICAgICBjb25zdCBmaWxlID0gY29uZmlnLmZpbGVcclxuICAgICAgY29uc3QgZmlsZVNpemUgPSBmaWxlLnNpemVcclxuICAgICAgaWYgKGZpbGVTaXplIDwgYmxvY2tTaXplKSB7XHJcbiAgICAgICAgICBtYXhCbG9ja1NpemUgPSBmaWxlU2l6ZVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChmaWxlU2l6ZSAlIG1heEJsb2NrU2l6ZSA9PT0gMCkge1xyXG4gICAgICAgICAgbnVtYmVyT2ZCbG9ja3MgPSBmaWxlU2l6ZSAvIG1heEJsb2NrU2l6ZVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbnVtYmVyT2ZCbG9ja3MgPSBmaWxlU2l6ZSAvIG1heEJsb2NrU2l6ZSArIDFcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIG1heEJsb2NrU2l6ZTogbWF4QmxvY2tTaXplLCAvLyBFYWNoIGZpbGUgd2lsbCBiZSBzcGxpdCBpbiAyNTYgS0IuXHJcbiAgICAgICAgICBudW1iZXJPZkJsb2NrczogbnVtYmVyT2ZCbG9ja3MsXHJcbiAgICAgICAgICB0b3RhbEJ5dGVzUmVtYWluaW5nOiBmaWxlU2l6ZSxcclxuICAgICAgICAgIGN1cnJlbnRGaWxlUG9pbnRlcjogMCxcclxuICAgICAgICAgIGJsb2NrSWRzOiBuZXcgQXJyYXkoKSxcclxuICAgICAgICAgIGJsb2NrSWRQcmVmaXg6ICdibG9jay0nLFxyXG4gICAgICAgICAgYnl0ZXNVcGxvYWRlZDogMCxcclxuICAgICAgICAgIHN1Ym1pdFVyaTogbnVsbCxcclxuICAgICAgICAgIGZpbGU6IGZpbGUsXHJcbiAgICAgICAgICBiYXNlVXJsOiBjb25maWcuYmFzZVVybCxcclxuICAgICAgICAgIHNhc1Rva2VuOiBjb25maWcuc2FzVG9rZW4sXHJcbiAgICAgICAgICBmaWxlVXJsOiBjb25maWcuYmFzZVVybCArIGNvbmZpZy5zYXNUb2tlbixcclxuICAgICAgICAgIHByb2dyZXNzOiBjb25maWcucHJvZ3Jlc3MsXHJcbiAgICAgICAgICBjb21wbGV0ZTogY29uZmlnLmNvbXBsZXRlLFxyXG4gICAgICAgICAgZXJyb3I6IGNvbmZpZy5lcnJvcixcclxuICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2VcclxuICAgICAgfVxyXG4gIH1cclxuICB1cGxvYWQgKGNvbmZpZzogVXBsb2FkQ29uZmlnKSB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuaW5pdGlhbGl6ZVN0YXRlKGNvbmZpZylcclxuICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICAgIHJlYWRlci5vbmxvYWRlbmQgPSAoZXZ0OiBhbnkpID0+IHtcclxuICAgICAgaWYgKGV2dC50YXJnZXQucmVhZHlTdGF0ZSA9PT0gMiAmJiAhc3RhdGUuY2FuY2VsbGVkKSB7XHJcbiAgICAgICAgY29uc3QgdXJpID0gc3RhdGUuZmlsZVVybCArICcmY29tcD1ibG9jayZibG9ja2lkPScgKyBzdGF0ZS5ibG9ja0lkc1tzdGF0ZS5ibG9ja0lkcy5sZW5ndGggLSAxXVxyXG4gICAgICAgIGNvbnN0IHJlcXVlc3REYXRhID0gZXZ0LnRhcmdldC5yZXN1bHRcclxuICAgICAgICBjb25zdCByZXF1ZXN0RGF0YTIgPSBuZXcgVWludDhBcnJheShldnQudGFyZ2V0LnJlc3VsdClcclxuICAgICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ3gtbXMtYmxvYi10eXBlJzogJ0Jsb2NrQmxvYicsICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KVxyXG4gICAgICAgIHRoaXMuaHR0cC5wdXQodXJpLCByZXF1ZXN0RGF0YSwgeyBoZWFkZXJzOiBoZWFkZXJzLCByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KVxyXG4gICAgICAgICAgLnN1YnNjcmliZShfZWxlbSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLmJ5dGVzVXBsb2FkZWQgKz0gcmVxdWVzdERhdGEyLmxlbmd0aFxyXG4gICAgICAgICAgICBjb25zdCBwZXJjZW50Q29tcGxldGUgPSBNYXRoLnJvdW5kKChzdGF0ZS5ieXRlc1VwbG9hZGVkIC8gc3RhdGUuZmlsZS5zaXplKSAqIDEwMDApIC8gMTBcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnByb2dyZXNzKSB7XHJcbiAgICAgICAgICAgICAgc3RhdGUucHJvZ3Jlc3MocGVyY2VudENvbXBsZXRlKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVJbkJsb2NrcyhyZWFkZXIsIHN0YXRlKVxyXG4gICAgICAgICAgfSwgZXJyID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coeyBlcnJvcjogZXJyIH0pXHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5lcnJvcikge1xyXG4gICAgICAgICAgICAgIHN0YXRlLmVycm9yKGVycilcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy51cGxvYWRGaWxlSW5CbG9ja3MocmVhZGVyLCBzdGF0ZSlcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBjYW5jZWw6ICgpID0+IHtcclxuICAgICAgICAgICAgICBzdGF0ZS5jYW5jZWxsZWQgPSB0cnVlXHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBwcmVwZW5kWmVyb3MgKG51bWJlciwgbGVuZ3RoKSB7XHJcbiAgICBsZXQgc3RyID0gJycgKyBudW1iZXJcclxuICAgIHdoaWxlIChzdHIubGVuZ3RoIDwgbGVuZ3RoKSB7XHJcbiAgICAgIHN0ciA9ICcwJyArIHN0clxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0clxyXG4gIH1cclxufVxyXG4iXX0=