/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
export class BlobService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
    }
    /**
     * @param {?} params
     * @param {?} filename
     * @param {?=} useAzureStorageEmulator
     * @param {?=} azureStorageEmulatorBaseUrl
     * @return {?}
     */
    generateBlobUrl(params, filename, useAzureStorageEmulator = false, azureStorageEmulatorBaseUrl = '') {
        /** @type {?} */
        const url = useAzureStorageEmulator ? azureStorageEmulatorBaseUrl : `https://${params.storageAccount}.blob.core.windows.net`;
        return `${url}/${params.containerName}/${filename}`;
    }
    /**
     * @param {?} reader
     * @param {?} state
     * @return {?}
     */
    uploadFileInBlocks(reader, state) {
        if (!state.cancelled) {
            if (state.totalBytesRemaining > 0) {
                /** @type {?} */
                const fileContent = state.file.slice(state.currentFilePointer, state.currentFilePointer + state.maxBlockSize);
                /** @type {?} */
                const blockId = state.blockIdPrefix + this.prependZeros(state.blockIds.length, 6);
                state.blockIds.push(btoa(blockId));
                reader.readAsArrayBuffer(fileContent);
                state.currentFilePointer += state.maxBlockSize;
                state.totalBytesRemaining -= state.maxBlockSize;
                if (state.totalBytesRemaining < state.maxBlockSize) {
                    state.maxBlockSize = state.totalBytesRemaining;
                }
            }
            else {
                this.commitBlockList(state);
            }
        }
    }
    /**
     * @param {?} state
     * @return {?}
     */
    commitBlockList(state) {
        /** @type {?} */
        const uri = state.fileUrl + '&comp=blocklist';
        /** @type {?} */
        const headers = new HttpHeaders({ 'x-ms-blob-content-type': state.file.type });
        /** @type {?} */
        let requestBody = '<?xml version=\'1.0\' encoding=\'utf-8\'?><BlockList>';
        for (let i = 0; i < state.blockIds.length; i++) {
            requestBody += '<Latest>' + state.blockIds[i] + '</Latest>';
        }
        requestBody += '</BlockList>';
        this.http.put(uri, requestBody, { headers: headers, responseType: 'text' })
            .subscribe(_elem => {
            if (state.complete) {
                state.complete();
            }
        }, err => {
            console.log({ error: err });
            if (state.error) {
                state.error(err);
            }
        });
    }
    /**
     * @param {?} config
     * @return {?}
     */
    initializeState(config) {
        /** @type {?} */
        let blockSize = BlobService.DefaultBlockSize;
        if (config.blockSize) {
            blockSize = config.blockSize;
        }
        /** @type {?} */
        let maxBlockSize = blockSize;
        /** @type {?} */
        let numberOfBlocks = 1;
        /** @type {?} */
        const file = config.file;
        /** @type {?} */
        const fileSize = file.size;
        if (fileSize < blockSize) {
            maxBlockSize = fileSize;
        }
        if (fileSize % maxBlockSize === 0) {
            numberOfBlocks = fileSize / maxBlockSize;
        }
        else {
            numberOfBlocks = fileSize / maxBlockSize + 1;
        }
        return {
            maxBlockSize: maxBlockSize,
            // Each file will be split in 256 KB.
            numberOfBlocks: numberOfBlocks,
            totalBytesRemaining: fileSize,
            currentFilePointer: 0,
            blockIds: new Array(),
            blockIdPrefix: 'block-',
            bytesUploaded: 0,
            submitUri: null,
            file: file,
            baseUrl: config.baseUrl,
            sasToken: config.sasToken,
            fileUrl: config.baseUrl + config.sasToken,
            progress: config.progress,
            complete: config.complete,
            error: config.error,
            cancelled: false
        };
    }
    /**
     * @param {?} config
     * @return {?}
     */
    upload(config) {
        /** @type {?} */
        const state = this.initializeState(config);
        /** @type {?} */
        const reader = new FileReader();
        reader.onloadend = (evt) => {
            if (evt.target.readyState === 2 && !state.cancelled) {
                /** @type {?} */
                const uri = state.fileUrl + '&comp=block&blockid=' + state.blockIds[state.blockIds.length - 1];
                /** @type {?} */
                const requestData = evt.target.result;
                /** @type {?} */
                const requestData2 = new Uint8Array(evt.target.result);
                /** @type {?} */
                const headers = new HttpHeaders({ 'x-ms-blob-type': 'BlockBlob', 'Content-Type': 'application/octet-stream' });
                this.http.put(uri, requestData, { headers: headers, responseType: 'text' })
                    .subscribe(_elem => {
                    state.bytesUploaded += requestData2.length;
                    /** @type {?} */
                    const percentComplete = Math.round((state.bytesUploaded / state.file.size) * 1000) / 10;
                    if (state.progress) {
                        state.progress(percentComplete);
                    }
                    this.uploadFileInBlocks(reader, state);
                }, err => {
                    console.log({ error: err });
                    if (state.error) {
                        state.error(err);
                    }
                });
            }
        };
        this.uploadFileInBlocks(reader, state);
        return {
            cancel: () => {
                state.cancelled = true;
            }
        };
    }
    /**
     * @param {?} number
     * @param {?} length
     * @return {?}
     */
    prependZeros(number, length) {
        /** @type {?} */
        let str = '' + number;
        while (str.length < length) {
            str = '0' + str;
        }
        return str;
    }
}
BlobService.DefaultBlockSize = 1024 * 32;
BlobService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BlobService.ctorParameters = () => [
    { type: HttpClient }
];
if (false) {
    /** @type {?} */
    BlobService.DefaultBlockSize;
    /** @type {?} */
    BlobService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvYi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1henVyZS1ibG9iLXNlcnZpY2UvIiwic291cmNlcyI6WyJzcmMvYXBwL21vZHVsZXMvYmxvYi9ibG9iLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDMUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUc5RCxNQUFNOzs7O0lBRUosWUFBcUIsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtLQUFLOzs7Ozs7OztJQUMxQyxlQUFlLENBQ2IsTUFBb0IsRUFDcEIsUUFBZ0IsRUFDaEIsdUJBQXVCLEdBQUcsS0FBSyxFQUMvQiwyQkFBMkIsR0FBRyxFQUFFOztRQUNoQyxNQUFNLEdBQUcsR0FBRyx1QkFBdUIsQ0FBQyxDQUFDLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxDQUFDLFdBQVcsTUFBTSxDQUFDLGNBQWMsd0JBQXdCLENBQUE7UUFDNUgsT0FBTyxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsYUFBYSxJQUFJLFFBQVEsRUFBRSxDQUFBO0tBQ3BEOzs7Ozs7SUFDTyxrQkFBa0IsQ0FBRSxNQUFNLEVBQUUsS0FBSztRQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLEVBQUU7O2dCQUMvQixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQTs7Z0JBQzdHLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFB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QUMsTUFBTSxHQUFHLE1BQU0sRUFBRTtZQUMxQixHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQTtTQUNoQjtRQUNELE9BQU8sR0FBRyxDQUFBOzs7K0JBN0hjLElBQUksR0FBRyxFQUFFOztZQUZwQyxVQUFVOzs7O1lBRkYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJ1xyXG5pbXBvcnQgeyBVcGxvYWRQYXJhbXMsIFVwbG9hZENvbmZpZyB9IGZyb20gJy4vZGVmaW5pdGlvbnMnXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJsb2JTZXJ2aWNlIHtcclxuICBzdGF0aWMgRGVmYXVsdEJsb2NrU2l6ZSA9IDEwMjQgKiAzMlxyXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxyXG4gIGdlbmVyYXRlQmxvYlVybCAoXHJcbiAgICBwYXJhbXM6IFVwbG9hZFBhcmFtcyxcclxuICAgIGZpbGVuYW1lOiBzdHJpbmcsXHJcbiAgICB1c2VBenVyZVN0b3JhZ2VFbXVsYXRvciA9IGZhbHNlLFxyXG4gICAgYXp1cmVTdG9yYWdlRW11bGF0b3JCYXNlVXJsID0gJycpIHtcclxuICAgIGNvbnN0IHVybCA9IHVzZUF6dXJlU3RvcmFnZUVtdWxhdG9yID8gYXp1cmVTdG9yYWdlRW11bGF0b3JCYXNlVXJsIDogYGh0dHBzOi8vJHtwYXJhbXMuc3RvcmFnZUFjY291bnR9LmJsb2IuY29yZS53aW5kb3dzLm5ldGBcclxuICAgIHJldHVybiBgJHt1cmx9LyR7cGFyYW1zLmNvbnRhaW5lck5hbWV9LyR7ZmlsZW5hbWV9YFxyXG4gIH1cclxuICBwcml2YXRlIHVwbG9hZEZpbGVJbkJsb2NrcyAocmVhZGVyLCBzdGF0ZSkge1xyXG4gICAgICBpZiAoIXN0YXRlLmNhbmNlbGxlZCkge1xyXG4gICAgICAgICAgaWYgKHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgPiAwKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmlsZUNvbnRlbnQgPSBzdGF0ZS5maWxlLnNsaWNlKHN0YXRlLmN1cnJlbnRGaWxlUG9pbnRlciwgc3RhdGUuY3VycmVudEZpbGVQb2ludGVyICsgc3RhdGUubWF4QmxvY2tTaXplKVxyXG4gICAgICAgICAgICAgIGNvbnN0IGJsb2NrSWQgPSBzdGF0ZS5ibG9ja0lkUHJlZml4ICsgdGhpcy5wcmVwZW5kWmVyb3Moc3RhdGUuYmxvY2tJZHMubGVuZ3RoLCA2KVxyXG4gICAgICAgICAgICAgIHN0YXRlLmJsb2NrSWRzLnB1c2goYnRvYShibG9ja0lkKSlcclxuICAgICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZUNvbnRlbnQpXHJcbiAgICAgICAgICAgICAgc3RhdGUuY3VycmVudEZpbGVQb2ludGVyICs9IHN0YXRlLm1heEJsb2NrU2l6ZVxyXG4gICAgICAgICAgICAgIHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgLT0gc3RhdGUubWF4QmxvY2tTaXplXHJcbiAgICAgICAgICAgICAgaWYgKHN0YXRlLnRvdGFsQnl0ZXNSZW1haW5pbmcgPCBzdGF0ZS5tYXhCbG9ja1NpemUpIHtcclxuICAgICAgICAgICAgICAgICAgc3RhdGUubWF4QmxvY2tTaXplID0gc3RhdGUudG90YWxCeXRlc1JlbWFpbmluZ1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jb21taXRCbG9ja0xpc3Qoc3RhdGUpXHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBjb21taXRCbG9ja0xpc3QgKHN0YXRlKSB7XHJcbiAgICAgIGNvbnN0IHVyaSA9IHN0YXRlLmZpbGVVcmwgKyAnJmNvbXA9YmxvY2tsaXN0J1xyXG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ3gtbXMtYmxvYi1jb250ZW50LXR5cGUnOiBzdGF0ZS5maWxlLnR5cGUgfSlcclxuICAgICAgbGV0IHJlcXVlc3RCb2R5ID0gJzw/eG1sIHZlcnNpb249XFwnMS4wXFwnIGVuY29kaW5nPVxcJ3V0Zi04XFwnPz48QmxvY2tMaXN0PidcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGF0ZS5ibG9ja0lkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgcmVxdWVzdEJvZHkgKz0gJzxMYXRlc3Q+JyArIHN0YXRlLmJsb2NrSWRzW2ldICsgJzwvTGF0ZXN0PidcclxuICAgICAgfVxyXG4gICAgICByZXF1ZXN0Qm9keSArPSAnPC9CbG9ja0xpc3Q+J1xyXG5cclxuICAgICAgdGhpcy5odHRwLnB1dCh1cmksIHJlcXVlc3RCb2R5LCB7IGhlYWRlcnM6IGhlYWRlcnMsIHJlc3BvbnNlVHlwZTogJ3RleHQnIH0pXHJcbiAgICAgICAgLnN1YnNjcmliZShfZWxlbSA9PiB7XHJcbiAgICAgICAgICBpZiAoc3RhdGUuY29tcGxldGUpIHtcclxuICAgICAgICAgICAgc3RhdGUuY29tcGxldGUoKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sIGVyciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyh7IGVycm9yOiBlcnIgfSlcclxuICAgICAgICAgIGlmIChzdGF0ZS5lcnJvcikge1xyXG4gICAgICAgICAgICBzdGF0ZS5lcnJvcihlcnIpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICB9XHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplU3RhdGUgKGNvbmZpZzogVXBsb2FkQ29uZmlnKSB7XHJcbiAgICAgIGxldCBibG9ja1NpemUgPSBCbG9iU2VydmljZS5EZWZhdWx0QmxvY2tTaXplXHJcbiAgICAgIGlmIChjb25maWcuYmxvY2tTaXplKSB7XHJcbiAgICAgICAgYmxvY2tTaXplID0gY29uZmlnLmJsb2NrU2l6ZVxyXG4gICAgICB9XHJcbiAgICAgIGxldCBtYXhCbG9ja1NpemUgPSBibG9ja1NpemVcclxuICAgICAgbGV0IG51bWJlck9mQmxvY2tzID0gMVxyXG4gICAgICBjb25zdCBmaWxlID0gY29uZmlnLmZpbGVcclxuICAgICAgY29uc3QgZmlsZVNpemUgPSBmaWxlLnNpemVcclxuICAgICAgaWYgKGZpbGVTaXplIDwgYmxvY2tTaXplKSB7XHJcbiAgICAgICAgICBtYXhCbG9ja1NpemUgPSBmaWxlU2l6ZVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChmaWxlU2l6ZSAlIG1heEJsb2NrU2l6ZSA9PT0gMCkge1xyXG4gICAgICAgICAgbnVtYmVyT2ZCbG9ja3MgPSBmaWxlU2l6ZSAvIG1heEJsb2NrU2l6ZVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbnVtYmVyT2ZCbG9ja3MgPSBmaWxlU2l6ZSAvIG1heEJsb2NrU2l6ZSArIDFcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIG1heEJsb2NrU2l6ZTogbWF4QmxvY2tTaXplLCAvLyBFYWNoIGZpbGUgd2lsbCBiZSBzcGxpdCBpbiAyNTYgS0IuXHJcbiAgICAgICAgICBudW1iZXJPZkJsb2NrczogbnVtYmVyT2ZCbG9ja3MsXHJcbiAgICAgICAgICB0b3RhbEJ5dGVzUmVtYWluaW5nOiBmaWxlU2l6ZSxcclxuICAgICAgICAgIGN1cnJlbnRGaWxlUG9pbnRlcjogMCxcclxuICAgICAgICAgIGJsb2NrSWRzOiBuZXcgQXJyYXkoKSxcclxuICAgICAgICAgIGJsb2NrSWRQcmVmaXg6ICdibG9jay0nLFxyXG4gICAgICAgICAgYnl0ZXNVcGxvYWRlZDogMCxcclxuICAgICAgICAgIHN1Ym1pdFVyaTogbnVsbCxcclxuICAgICAgICAgIGZpbGU6IGZpbGUsXHJcbiAgICAgICAgICBiYXNlVXJsOiBjb25maWcuYmFzZVVybCxcclxuICAgICAgICAgIHNhc1Rva2VuOiBjb25maWcuc2FzVG9rZW4sXHJcbiAgICAgICAgICBmaWxlVXJsOiBjb25maWcuYmFzZVVybCArIGNvbmZpZy5zYXNUb2tlbixcclxuICAgICAgICAgIHByb2dyZXNzOiBjb25maWcucHJvZ3Jlc3MsXHJcbiAgICAgICAgICBjb21wbGV0ZTogY29uZmlnLmNvbXBsZXRlLFxyXG4gICAgICAgICAgZXJyb3I6IGNvbmZpZy5lcnJvcixcclxuICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2VcclxuICAgICAgfVxyXG4gIH1cclxuICB1cGxvYWQgKGNvbmZpZzogVXBsb2FkQ29uZmlnKSB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuaW5pdGlhbGl6ZVN0YXRlKGNvbmZpZylcclxuICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICAgIHJlYWRlci5vbmxvYWRlbmQgPSAoZXZ0OiBhbnkpID0+IHtcclxuICAgICAgaWYgKGV2dC50YXJnZXQucmVhZHlTdGF0ZSA9PT0gMiAmJiAhc3RhdGUuY2FuY2VsbGVkKSB7XHJcbiAgICAgICAgY29uc3QgdXJpID0gc3RhdGUuZmlsZVVybCArICcmY29tcD1ibG9jayZibG9ja2lkPScgKyBzdGF0ZS5ibG9ja0lkc1tzdGF0ZS5ibG9ja0lkcy5sZW5ndGggLSAxXVxyXG4gICAgICAgIGNvbnN0IHJlcXVlc3REYXRhID0gZXZ0LnRhcmdldC5yZXN1bHRcclxuICAgICAgICBjb25zdCByZXF1ZXN0RGF0YTIgPSBuZXcgVWludDhBcnJheShldnQudGFyZ2V0LnJlc3VsdClcclxuICAgICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ3gtbXMtYmxvYi10eXBlJzogJ0Jsb2NrQmxvYicsICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KVxyXG4gICAgICAgIHRoaXMuaHR0cC5wdXQodXJpLCByZXF1ZXN0RGF0YSwgeyBoZWFkZXJzOiBoZWFkZXJzLCByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KVxyXG4gICAgICAgICAgLnN1YnNjcmliZShfZWxlbSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLmJ5dGVzVXBsb2FkZWQgKz0gcmVxdWVzdERhdGEyLmxlbmd0aFxyXG4gICAgICAgICAgICBjb25zdCBwZXJjZW50Q29tcGxldGUgPSBNYXRoLnJvdW5kKChzdGF0ZS5ieXRlc1VwbG9hZGVkIC8gc3RhdGUuZmlsZS5zaXplKSAqIDEwMDApIC8gMTBcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnByb2dyZXNzKSB7XHJcbiAgICAgICAgICAgICAgc3RhdGUucHJvZ3Jlc3MocGVyY2VudENvbXBsZXRlKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGVJbkJsb2NrcyhyZWFkZXIsIHN0YXRlKVxyXG4gICAgICAgICAgfSwgZXJyID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coeyBlcnJvcjogZXJyIH0pXHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5lcnJvcikge1xyXG4gICAgICAgICAgICAgIHN0YXRlLmVycm9yKGVycilcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy51cGxvYWRGaWxlSW5CbG9ja3MocmVhZGVyLCBzdGF0ZSlcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBjYW5jZWw6ICgpID0+IHtcclxuICAgICAgICAgICAgICBzdGF0ZS5jYW5jZWxsZWQgPSB0cnVlXHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBwcmVwZW5kWmVyb3MgKG51bWJlciwgbGVuZ3RoKSB7XHJcbiAgICBsZXQgc3RyID0gJycgKyBudW1iZXJcclxuICAgIHdoaWxlIChzdHIubGVuZ3RoIDwgbGVuZ3RoKSB7XHJcbiAgICAgIHN0ciA9ICcwJyArIHN0clxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0clxyXG4gIH1cclxufVxyXG4iXX0=