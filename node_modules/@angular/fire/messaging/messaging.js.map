{"version":3,"file":"messaging.js","sourceRoot":"","sources":["../../../src/messaging/messaging.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional, NgZone, PLATFORM_ID } from '@angular/core';\nimport { isPlatformServer } from '@angular/common';\nimport { messaging } from 'firebase/app';\nimport { Observable, empty, from, of, throwError } from 'rxjs';\nimport { mergeMap, catchError, map, switchMap, concat, defaultIfEmpty } from 'rxjs/operators';\nimport { FirebaseOptions, FirebaseAppConfig, runOutsideAngular } from '@angular/fire';\nimport { FirebaseOptionsToken, FirebaseNameOrConfigToken, _firebaseAppFactory, FirebaseZoneScheduler } from '@angular/fire';\n\n@Injectable()\nexport class AngularFireMessaging {\n  messaging: Observable<messaging.Messaging>;\n  requestPermission: Observable<void>;\n  getToken: Observable<string|null>;\n  tokenChanges: Observable<string|null>;\n  messages: Observable<{}>;\n  requestToken: Observable<string|null>;\n  deleteToken: (token: string) => Observable<boolean>;\n\n  constructor(\n    @Inject(FirebaseOptionsToken) options:FirebaseOptions,\n    @Optional() @Inject(FirebaseNameOrConfigToken) nameOrConfig:string|FirebaseAppConfig|null|undefined,\n    @Inject(PLATFORM_ID) platformId: Object,\n    zone: NgZone\n  ) {\n\n    // @ts-ignore zapping in the UMD in the build script\n    const requireMessaging = from(import('firebase/messaging'));\n\n    this.messaging = requireMessaging.pipe(\n      map(() => _firebaseAppFactory(options, nameOrConfig)),\n      map(app => app.messaging()),\n      runOutsideAngular(zone)\n    );\n\n    if (!isPlatformServer(platformId)) {\n\n      this.requestPermission = this.messaging.pipe(\n        switchMap(messaging => messaging.requestPermission()),\n        runOutsideAngular(zone)\n      );\n\n    } else {\n\n      this.requestPermission = throwError('Not available on server platform.');\n\n    }\n\n    this.getToken = this.messaging.pipe(\n      switchMap(messaging => messaging.getToken()),\n      defaultIfEmpty(null),\n      runOutsideAngular(zone)\n    );\n\n    const tokenChanges = this.messaging.pipe(\n      switchMap(messaging => new Observable(messaging.onTokenRefresh.bind(messaging)).pipe(\n        switchMap(() => messaging.getToken())\n      )),\n      runOutsideAngular(zone)\n    );\n\n    this.tokenChanges = this.getToken.pipe(\n      concat(tokenChanges)\n    );\n\n    this.messages = this.messaging.pipe(\n      switchMap(messaging => new Observable(messaging.onMessage.bind(messaging))),\n      runOutsideAngular(zone)\n    );\n\n    this.requestToken = this.requestPermission.pipe(\n      catchError(() => of(null)),\n      mergeMap(() => this.tokenChanges)\n    );\n\n    this.deleteToken = (token: string) => this.messaging.pipe(\n      switchMap(messaging => messaging.deleteToken(token)),\n      defaultIfEmpty(false),\n      runOutsideAngular(zone)\n    );\n  }\n\n}\n"]}